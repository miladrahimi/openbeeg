<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>OpenBeeg > Video</title>
    <link rel="stylesheet" href="css/general.css">
    <style>
        #links {
            padding: 0 5%;
        }

        #links a {
            display: inline-block;
            margin: 15px;
        }

        #links img {
            width: 16px;
            height: 16px;
            position: relative;
            top: 3px;
            border-radius: 50%;
            border: solid 1px blue;
        }

        #player {
            margin: 15px auto;
        }

        #player video {
            width: auto;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 15px auto;
        }
    </style>
</head>

<body>
<header>
    <h1><a href="/">&#128166; OpenBeeg!</a></h1>
    <nav>
        <a href="index.html">Home</a> |
        <a href="tags.html">Tags</a>
    </nav>
</header>

<h2>Loading title...</h2>

<p id="loading">LOADING...</p>

<section id="links"></section>

<section id="player"></section>

<section><p>Made for E.H.Talaei!</p></section>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="js/general.js"></script>
<script>
    $(document).ready(function () {
        let videoId = new URLSearchParams(window.location.search).get('id');
        let bundleVersion = 0;

        if (!videoId) {
            window.location.href = 'index.html';
        }

        // Load the video page
        $.ajax({
            url: proxyUrl,
            type: 'GET',
            data: {url: baseUrl + videoId}
        }).done(function (response) {
            let version = response.match(/beeg_version = ([\d]+);/)[1];
            fetchVideo(version);
        }).fail(function () {
            alert('Cannot load the video page.');
        });

        // Fetch the video information
        function fetchVideo(version) {
            $.ajax({
                url: proxyUrl,
                type: 'GET',
                data: {url: `https://beeg.com/api/v6/${version}/video/${videoId}?v=2`}
            }).done(function (response) {
                bundleVersion = response['bundle_version'];
                $('h2').html(response['title']);

                let range = '';
                if (response['start'] && response['end']) {
                    range = '_' + response['start'] + '_' + response['end'];
                }

                $('#player').append('<select id="videos" title="Video"></select>');

                let qualities = ['240p', '480p', '720p', '1080p', '2160p'];
                $.each(qualities, function (i, quality) {
                    if (response[quality]) {
                        fetchLinks(response[quality], quality, range, 'TR');
                        fetchLinks(response[quality], quality, range, 'US');
                        fetchLinks(response[quality], quality, range, 'PK');
                    }
                });
            }).fail(function () {
                alert('Cannot load the video information.');
            });
        }

        // Generate video link
        function generateLink(link, range, country) {
            let markers = `data=pc_${country}__${bundleVersion}_`;
            return 'https:' + link.replace('{DATA_MARKERS}', markers) + range;
        }

        // Fetch final links for the video
        function fetchLinks(link, quality, range, country) {
            $.ajax({
                url: proxyUrl,
                type: 'GET',
                data: {
                    url: generateLink(link, range, country),
                    redirection: 'stop',
                    h_referer: baseUrl,
                }
            }).done(function (response) {
                let link = $('<a href="#" target="_blank"></a>');
                link.attr('href', response['location']);
                link.html(flag(country) + ' ' + quality);
                link.appendTo('#links');

                let option = $('<option></option>');
                option.attr('value', proxify(response['location']));
                option.html(country + ' ' + quality);
                option.appendTo('#videos');

                play(undefined);
            }).fail(function () {
                let link = $('<p></p>');
                link.html(flag(country) + ' ' + quality);
                link.appendTo('#links');
            }).always(function () {
                $('#loading').hide();
            });
        }

        function flag(country) {
            let url = 'https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.3.0/flags/1x1/country.svg';
            let flag = url.replace('country', country.toLowerCase());

            return `<img src="${flag}" alt="${country}">`;
        }

        function play(link) {
            if (link === undefined) {
                link = $('#videos').val();
            }

            if ($('video').length === 0) {
                let video = $('<video></video>');
                video.attr('src', link);
                video.attr('preload', 'metadata');
                video.attr('controls', true);
                video.attr('playsinline', true);
                video.appendTo('#player');
            }
        }

        $(document).on('change', '#videos', function () {
            $('video').attr('src', $(this).val());
        });

        $(document).on('click', '#links a', function (e) {
            e.preventDefault();
            alert('Copy the link address and paste it in a new tab or window.')
        });
    });
</script>
</body>
</html>
