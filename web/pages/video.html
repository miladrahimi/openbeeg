<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="referrer" content="no-referrer">
    <title>OpenBeeg!</title>
    <link rel="stylesheet" href="../assets/css/general.css?md5=b2e8b245cf6914db5f4d818518804b23">
    <link rel="stylesheet" href="../assets/css/video.css?md5=f5aea62eef6cf532a6384021bf92f584">
    <link rel="apple-touch-icon" sizes="160x160" href="../assets/img/logo.png">
    <link rel="manifest" href="../manifest.json">
</head>

<body>

<header><a href="index.html">&#128166;</a></header>

<h3>Loading...</h3>

<section id="links-us" class="links"></section>
<section id="links-tr" class="links"></section>
<section id="links-pk" class="links"></section>

<section id="player"></section>

<p>Copyfuck &copy; by M.R. Offered by E.H.T.</p>

<!-- Scripts -->
<script src="../assets/vendor/jquery-3.3.1.min.js"></script>
<script src="../assets/js/general.js"></script>
<script>
    $(document).ready(function () {
        let videoId = new URLSearchParams(window.location.search).get('id');
        let mainVersion = 0;
        let bundleVersion = 0;

        // Load the video page
        $.ajax({
            url: proxyUrl,
            type: 'GET',
            data: {url: baseUrl + videoId}
        }).done(response => {
            mainVersion = response.match(/beeg_version = ([\d]+);/)[1];
            fetchDetails();
        }).fail(() => {
            alert('Cannot load the video page.');
        });

        function fetchDetails() {
            $.ajax({
                url: proxyUrl,
                type: 'GET',
                data: {
                    url: `https://beeg.com/api/v6/${mainVersion}/video/${videoId}?v=2`,
                }
            }).done(response => {
                bundleVersion = response['bundle_version'];

                $('h3').html(response['title'] ? response['title'] : response['ps_name']);

                let range = '';
                if (response['start'] && response['end']) {
                    range = '_' + response['start'] + '_' + response['end'];
                }

                $.each(['240p', '480p', '720p', '1080p', '2160p'], function (i, quality) {
                    if (response[quality]) {
                        fetchLinks(response[quality], quality, range, 'US');
                        fetchLinks(response[quality], quality, range, 'TR');
                        fetchLinks(response[quality], quality, range, 'PK');
                    }
                });
            }).fail(() => {
                alert('Cannot load the video details.');
            });
        }

        // Fetch final links for the video
        function fetchLinks(link, quality, range, country) {
            $.ajax({
                url: proxyUrl,
                type: 'GET',
                data: {
                    url: 'https:' + link.replace('{DATA_MARKERS}', `data=pc_${country}__${bundleVersion}_`) + range,
                    redirection: 'stop',
                    h_referer: baseUrl,
                }
            }).done(response => {
                let link = $('<a target="_blank" rel="noreferrer"></a>');
                link.attr('href', response['location']);
                link.html(createFlag(country) + ' ' + quality);
                link.appendTo('#links-' + country.toLowerCase());

                $('video').length === 0 && createPlayer(proxify(response['location']));
            }).fail(() => {
                let link = $('<span></span>');
                link.html(createFlag(country) + ' ' + quality);
                link.appendTo('#links');
            });
        }

        function createFlag(country) {
            let url = 'https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.3.0/flags/1x1/country.svg';
            let flag = url.replace('country', country.toLowerCase());

            return `<img src="${flag}" alt="${country}">`;
        }

        function createPlayer(link) {
            let video = $('<video></video>');
            video.attr('src', link);
            video.attr('preload', 'metadata');
            video.attr('controls', true);
            video.attr('playsinline', true);
            video.appendTo('#player');
        }
    });
</script>
</body>
</html>
